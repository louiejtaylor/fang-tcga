#-*- mode: Snakemake -*-
#
# Workflow for dumping non-human reads from The Cancer Genome Atlas, mapping
# them to targets, then summarizing/visualizing results.
#

rule mapping_stats:
	input: 
		bam = output_dir/"alignments"/"{sample}.sorted.bam",
		idx = output_dir/"alignments"/"{sample}.sorted.bam.bai"
	output:
		output_dir/"summary"/"idxstats"/"{sample}.sorted.idxstats.tsv"
    conda:
        "alignment_processing_env.yml"
	shell:
		"""
		samtools idxstats {input.bam} > {output}
		"""
rule calculate_coverage:
        input:
                bam = output_dir/"alignments"/"{sample}.sorted.bam",                                                               idx = output_dir/"alignments"/"{sample}.sorted.bam.bai"
	output:
		output_dir/"summary"/"coverage"/"{sample}.genomecoverage.txt"
    conda:
        "alignment_processing_env.yml"
	shell:
		"""
		samtools view -b {input.bam}|genomeCoverageBed -ibam stdin|grep -v 'genome'| perl hisss/scripts/coverage_counter.pl > {output}	
		"""

rule combine_coverage_stats:
	input:
		cov = output_dir/"summary"/"coverage"/"{sample}.genomecoverage.txt",
		stats = output_dir/"summary"/"idxstats"/"{sample}.sorted.idxstats.tsv"
	output:
		output_dir/"summary"/"individual"/"{sample}.align.summary.txt"
    conda:
        "r_plot.yml"
	shell:
		"""
		Rscript hisss/scripts/summarize_alignments.R {input.cov} {input.stats} {output}
		"""

#Combine information for all samples into a single file
rule all_summary:
	input:
		expand(str(output_dir/"summary"/"individual"/"{sample}.align.summary.txt"),sample=Samples)
	output:
		output_dir/"summary"/"all_align_summary.txt"
	params:
		align_dir = output_dir/"summary"/"individual"
	shell:
		"""
		echo -e "Sample\tAlignTarget\tFractionCoverage\tTargetLength\tMappedReads" > {output}
		cat {params.align_dir}/*.align.summary.txt >> {output}
		"""
